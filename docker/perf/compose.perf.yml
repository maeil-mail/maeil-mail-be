# docker compose -f compose.perf.yml --env-file ./env/perf.env up -d --build
# docker compose -f compose.perf.yml down

services:
  lb-active:
    container_name: lb-active
    build:
      context: .
      dockerfile: Dockerfile.lb
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./keepalived/active/keepalived.conf:/etc/keepalived/keepalived.conf:ro
    networks:
      perf-network:
        ipv4_address: 172.16.0.3
    cap_add:
      - NET_ADMIN
    depends_on:
      - mm-app-1
      - mm-app-2
    ports:
      - "8888:80"
      - "8404:8404"

  lb-passive:
    container_name: lb-passive
    build:
      context: .
      dockerfile: Dockerfile.lb
    volumes:
      - ./haproxy/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
      - ./keepalived/passive/keepalived.conf:/etc/keepalived/keepalived.conf:ro
    networks:
      perf-network:
        ipv4_address: 172.16.0.4
    cap_add:
      - NET_ADMIN
    depends_on:
      - mm-app-1
      - mm-app-2
    ports:
      - "8800:80"
      - "8405:8404"

  mm-app-1:
    container_name: mm-app-1
    build:
      context: ../../
      dockerfile: docker/perf/Dockerfile.app
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.5
    depends_on:
      - mm-mysql
      - mm-mail
      - dd-agent
    cpus: 1.0
    mem_limit: 1g
    environment:
      ## datadog
      DD_AGENT_HOST: dd-agent
      DD_SERVICE: maeilmail-api-perf
      DD_ENV: perf
      DD_PROFILING_ENABLED: true
      DD_LOGS_INJECTION: true
      DATADOG_TAG: perf_app_1
      DATADOG_KEY: ${DD_API_KEY}
      DATADOG_URI: ${DATADOG_URI}
      DATADOG_FREQUENCY: ${DATADOG_FREQUENCY}

      ## db
      DB_DBNAME: maeilmail
      DB_ENDPOINT: mm-mysql:3306
      DB_USERNAME: atom
      DB_PASSWORD: atom

      ## mail
      MAIL_HOST: host.docker.internal
      MAIL_USERNAME: atom
      MAIL_PASSWORD: atom

      ## app
      TOKEN_ACCESS_EXP_TIME: ${TOKEN_ACCESS_EXP_TIME}
      TOKEN_REFRESH_EXP_TIME: ${TOKEN_REFRESH_EXP_TIME}
      TOKEN_SECRET_KEY: ${TOKEN_SECRET_KEY}
      ADMIN_SECRET: ${ADMIN_SECRET}
      DISTRIBUTE_SERVER_INDEX: 1
      DISTRIBUTE_SERVER_COUNT: 2
      USER_TIMEZONE: Asia/Seoul
      SPRING_PROFILES_ACTIVE: prod
#    ports:
#      - "8080:8080"

  mm-app-2:
    container_name: mm-app-2
    build:
      context: ../../
      dockerfile: docker/perf/Dockerfile.app
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.6
    depends_on:
      - mm-mysql
      - mm-mail
      - dd-agent
    cpus: 1.0
    mem_limit: 1g
    environment:
      ## datadog
      DD_AGENT_HOST: dd-agent
      DD_SERVICE: maeilmail-api-perf
      DD_ENV: perf
      DD_PROFILING_ENABLED: true
      DD_LOGS_INJECTION: true
      DATADOG_TAG: perf_app_2
      DATADOG_KEY: ${DD_API_KEY}
      DATADOG_URI: ${DATADOG_URI}
      DATADOG_FREQUENCY: ${DATADOG_FREQUENCY}

      ## db
      DB_DBNAME: maeilmail
      DB_ENDPOINT: mm-mysql:3306
      DB_USERNAME: atom
      DB_PASSWORD: atom

      ## mail
      MAIL_HOST: host.docker.internal
      MAIL_USERNAME: atom
      MAIL_PASSWORD: atom

      ## app
      TOKEN_ACCESS_EXP_TIME: ${TOKEN_ACCESS_EXP_TIME}
      TOKEN_REFRESH_EXP_TIME: ${TOKEN_REFRESH_EXP_TIME}
      TOKEN_SECRET_KEY: ${TOKEN_SECRET_KEY}
      ADMIN_SECRET: ${ADMIN_SECRET}
      DISTRIBUTE_SERVER_INDEX: 2
      DISTRIBUTE_SERVER_COUNT: 2
      USER_TIMEZONE: Asia/Seoul
      SPRING_PROFILES_ACTIVE: prod
#    ports:
#      - "8080:8080"

  mm-mysql:
    container_name: mm-mysql
    image: mysql:8.0.40
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.7
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: maeilmail
      MYSQL_USER: atom
      MYSQL_PASSWORD: atom
      TZ: Asia/Seoul
    volumes:
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
      - ./mysql/data:/var/lib/mysql
    ports:
      - "3306:3306"

  mm-mail:
    container_name: mm-mail
    image: mailhog/mailhog
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.8
    ports:
      - "587:1025"
      - "8025:8025"

  dd-agent:
    container_name: dd-agent
    image: gcr.io/datadoghq/agent:latest
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.9
    environment:
      DD_API_KEY: ${DD_API_KEY}
      DD_SITE: ${DD_SITE}
      DD_APM_NON_LOCAL_TRAFFIC: true
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /proc/:/host/proc/:ro
      - /sys/fs/cgroup:/host/sys/fs/cgroup:ro

  k6:
    container_name: k6
    platform: linux/amd64
    build:
      context: .
      dockerfile: Dockerfile.k6
    restart: no
    networks:
      perf-network:
        ipv4_address: 172.16.0.10
    cpus: 2.0
    mem_limit: 2g
    stdin_open: true
    tty: true

networks:
  perf-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.16.0.0/16
